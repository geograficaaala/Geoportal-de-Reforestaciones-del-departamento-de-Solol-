<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geoportal · Reforestación</title>

  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <style>
    :root{
      --bg:#0d1117;
      --panel:#121821;
      --card:#161f2b;
      --line:rgba(255,255,255,.10);
      --ink:#e6edf3;
      --muted:#9aa7b2;
      --accent:#4bd190;
      --r:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    a{color:inherit}

    header{
      position:sticky;top:0;z-index:10;
      background:linear-gradient(90deg,#0b0f14,#0e141d,#0b0f14);
      border-bottom:1px solid var(--line);
      padding:10px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:260px}
    .logos{display:flex;gap:8px;align-items:center}
    .logos img{
      height:38px;width:auto;border-radius:12px;
      background:#0b0f14;border:1px solid var(--line);
      padding:6px;
    }
    .titleWrap{display:flex;flex-direction:column;gap:2px}
    .ttl{font-weight:800;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted)}
    .btns{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--ink);
      padding:8px 10px;
      border-radius:14px;
      font-size:13px;
      cursor:pointer;
      text-decoration:none;
    }
    .btn:hover{border-color:rgba(75,209,144,.45)}
    .btn.primary{background:rgba(75,209,144,.10);border-color:rgba(75,209,144,.35)}

    .wrap{height:calc(100vh - 64px);display:grid;grid-template-columns:360px 1fr}
    aside{
      background:var(--panel);
      border-right:1px solid var(--line);
      padding:12px;
      overflow:auto;
    }

    /* Map frame (sirve también para impresión) */
    #mapFrame{position:relative;width:100%;height:100%}
    #map{position:absolute;inset:0}

    /* Overlays para impresión */
    #printNorth, #printScaleBox{display:none}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:10px;
      margin-bottom:10px;
    }
    .card h3{margin:0 0 8px;font-size:13px;color:var(--ink);letter-spacing:.2px}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    input,select{
      background:#0b0f14;color:var(--ink);
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 10px;
      font-size:13px;
      width:100%;
    }
    .status{
      font-size:12px;color:var(--muted);
      padding:8px 10px;border:1px dashed rgba(255,255,255,.16);
      border-radius:14px;background:rgba(0,0,0,.18)
    }

    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr}
      aside{display:none}
    }

    /* =========================
       MODO IMPRESIÓN (PDF PRO)
       ========================= */
    body.print-mode header,
    body.print-mode aside{display:none !important}

    body.print-mode{
      background:#fff !important;
      color:#000 !important;
    }

    /* Plantilla A4 horizontal */
    body.print-mode .wrap{
      display:block;
      height:auto;
      background:#fff;
    }

    /* Contenedor de hoja */
    #printSheet{display:none}
    body.print-mode #printSheet{
      display:block;
      padding:0;
      background:#fff;
    }

    /* Ocultar controles MapLibre en impresión */
    body.print-mode .maplibregl-control-container{display:none !important}

    /* Área mapa y marco */
    body.print-mode #mapFrame{
      width:277mm;              /* A4 landscape = 297mm, con margen 10mm a cada lado */
      height:150mm;
      margin:10mm auto 0;
      border:2px solid #000;
      background:#fff;
    }

    /* Mostrar overlays en impresión */
    body.print-mode #printNorth,
    body.print-mode #printScaleBox{
      display:block;
      position:absolute;
      z-index:20;
      background:rgba(255,255,255,.92);
      border:1px solid #000;
      padding:6px 8px;
      border-radius:6px;
      color:#000;
      font-family:system-ui,Segoe UI,Roboto,Arial;
    }

    body.print-mode #printNorth{
      top:8mm; right:8mm;
      width:36mm;
      text-align:center;
    }

    body.print-mode #printScaleBox{
      left:8mm; bottom:8mm;
      width:auto;
      min-width:60mm;
    }

    /* Cajetín */
    body.print-mode #printCajetin{
      width:277mm;
      margin:6mm auto 0;
      border:2px solid #000;
      padding:5mm;
      display:grid;
      grid-template-columns:62mm 1fr 75mm;
      gap:6mm;
      align-items:stretch;
      background:#fff;
    }

    body.print-mode #printCajetin .pLogos{
      display:flex; gap:6mm; align-items:center; justify-content:flex-start;
    }
    body.print-mode #printCajetin .pLogos img{
      height:22mm; width:auto;
      border:1px solid #000;
      border-radius:4mm;
      padding:2mm;
    }

    body.print-mode .pTitle{
      display:flex; flex-direction:column; justify-content:space-between;
    }
    body.print-mode .pTitle .h1{
      font-size:16px; font-weight:800; margin:0;
    }
    body.print-mode .pTitle .h2{
      font-size:12px; margin:2mm 0 0; color:#111;
    }
    body.print-mode .pTitle .note{
      font-size:10px; color:#111;
      margin-top:3mm;
    }

    body.print-mode .pMeta{
      font-size:10px;
      border-left:1px solid #000;
      padding-left:4mm;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    body.print-mode .pMeta .row{
      display:flex; justify-content:space-between; gap:6mm;
      border-bottom:1px dotted #000;
      padding:1mm 0;
    }
    body.print-mode .pMeta .row:last-child{border-bottom:none}
    body.print-mode .pMeta b{font-weight:800}

    body.print-mode #printHeaderLine{
      width:277mm;
      margin:8mm auto 0;
      display:flex;
      justify-content:space-between;
      font-size:10px;
      color:#000;
    }

    @page{
      size: A4 landscape;
      margin: 0;
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logos">
      <img src="../../assets/img/BOSQUE.png" alt="BOSQUE" />
      <img src="../../assets/img/CODEMA%20(2).png" alt="CODEMA" />
    </div>
    <div class="titleWrap">
      <div class="ttl">Geoportal · Reforestación</div>
      <div class="sub">Sololá, Guatemala · KoBo se actualiza automáticamente</div>
    </div>
  </div>

  <div class="btns">
    <a class="btn" href="../../index.html">Inicio</a>
    <a class="btn" href="./index.html">Módulo</a>
    <a class="btn" href="../../data/puntos.geojson" download>Descargar puntos</a>
    <button class="btn primary" id="printBtn">Imprimir PDF</button>
  </div>
</header>

<div class="wrap">
  <aside>
    <div class="card">
      <h3>Basemap</h3>
      <div class="grid2">
        <button class="btn" id="bmSat">Satélite</button>
        <button class="btn" id="bmOsm">Calles</button>
      </div>
      <div style="margin-top:8px">
        <button class="btn" id="bmDark">Oscuro</button>
      </div>
      <div class="small" style="margin-top:8px">
        El mapa oscuro se ve mejor con capas verdes suaves.
      </div>
    </div>

    <div class="card">
      <h3>KoBo</h3>
      <div class="small">Puntos actualizados por GitHub Actions.</div>
      <div class="small" style="margin-top:6px">Mostrando: <b id="koboShown">—</b> / <span id="koboTotal">—</span></div>
      <div class="status" style="margin-top:8px" id="statusBox">Cargando puntos…</div>
    </div>
  </aside>

  <div id="mapFrame">
    <div id="map"></div>

    <!-- Overlay norte (solo impresión) -->
    <div id="printNorth">
      <div style="font-weight:800;margin-bottom:2mm">N</div>
      <svg id="northSvg" viewBox="0 0 100 140" width="100%" height="70">
        <polygon points="50,5 80,80 50,70 20,80" fill="#000"></polygon>
        <polygon points="50,70 80,80 50,135 20,80" fill="#fff" stroke="#000" stroke-width="2"></polygon>
      </svg>
    </div>

    <!-- Overlay escala (solo impresión) -->
    <div id="printScaleBox">
      <div style="font-size:10px;font-weight:800;margin-bottom:2mm">Escala</div>
      <div id="scaleBar" style="height:8mm;display:flex;border:1px solid #000"></div>
      <div style="display:flex;justify-content:space-between;font-size:10px;margin-top:2mm">
        <span>0</span>
        <span id="scaleLabel">—</span>
      </div>
      <div style="font-size:9px;margin-top:1mm" id="scaleRatio">1:—</div>
    </div>
  </div>
</div>

<!-- Plantilla visible SOLO en impresión (texto superior + cajetín) -->
<div id="printSheet">
  <div id="printHeaderLine">
    <div id="printDate">—</div>
    <div id="printTitleCenter" style="font-weight:800">Geoportal · Reforestación</div>
    <div id="printCRS">WGS84 / Web Mercator</div>
  </div>

  <div id="printCajetin">
    <div class="pLogos">
      <img src="../../assets/img/BOSQUE.png" alt="BOSQUE" />
      <img src="../../assets/img/CODEMA%20(2).png" alt="CODEMA" />
    </div>

    <div class="pTitle">
      <div>
        <p class="h1">Geoportal · Reforestación</p>
        <p class="h2">Departamento de Sololá, Guatemala</p>
        <p class="note">Fuente de datos: KoBoToolbox (boletas) · Publicación: GitHub Pages</p>
      </div>
      <div style="font-size:10px;margin-top:2mm">
        <b>Elaboró:</b> Laboratorio SIG del eje de bosques de CODEMA-Sololá
      </div>
    </div>

    <div class="pMeta">
      <div>
        <div class="row"><span><b>Fecha</b></span><span id="metaFecha">—</span></div>
        <div class="row"><span><b>Hora</b></span><span id="metaHora">—</span></div>
        <div class="row"><span><b>Escala</b></span><span id="metaEscala">—</span></div>
        <div class="row"><span><b>Zoom</b></span><span id="metaZoom">—</span></div>
        <div class="row"><span><b>Base</b></span><span id="metaBase">—</span></div>
      </div>
      <div style="font-size:9px;color:#111;margin-top:2mm">
        Nota: La escala es aproximada (depende del zoom y centro del mapa).
      </div>
    </div>
  </div>
</div>

<script>
  // Basemaps como raster (no reiniciamos estilo, solo visibility)
  const styleBase = {
    "version": 8,
    "sources": {
      "sat": {
        "type": "raster",
        "tiles": ["https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"],
        "tileSize": 256,
        "attribution": "Esri"
      },
      "osm": {
        "type": "raster",
        "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
        "tileSize": 256,
        "attribution": "© OpenStreetMap"
      },
      "dark": {
        "type": "raster",
        "tiles": [
          "https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
          "https://b.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
          "https://c.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
          "https://d.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png"
        ],
        "tileSize": 256,
        "attribution": "© CARTO"
      }
    },
    "layers": [
      { "id": "bm-sat",  "type": "raster", "source": "sat",  "layout": { "visibility": "visible" } },
      { "id": "bm-osm",  "type": "raster", "source": "osm",  "layout": { "visibility": "none" } },
      { "id": "bm-dark", "type": "raster", "source": "dark", "layout": { "visibility": "none" } }
    ]
  };

  const map = new maplibregl.Map({
    container: "map",
    style: styleBase,
    center: [-91.18, 14.77],
    zoom: 10
  });

  map.addControl(new maplibregl.NavigationControl(), "top-right");

  const statusBox = document.getElementById("statusBox");
  const koboShown = document.getElementById("koboShown");
  const koboTotal = document.getElementById("koboTotal");

  function showBasemap(which){
    ["bm-sat","bm-osm","bm-dark"].forEach(id => map.setLayoutProperty(id, "visibility", "none"));
    if(which === "sat")  map.setLayoutProperty("bm-sat", "visibility", "visible");
    if(which === "osm")  map.setLayoutProperty("bm-osm", "visibility", "visible");
    if(which === "dark") map.setLayoutProperty("bm-dark", "visibility", "visible");
    document.getElementById("metaBase").textContent =
      (which === "sat") ? "Satélite" : (which === "osm") ? "Calles" : "Oscuro";
  }
  document.getElementById("bmSat").onclick  = () => showBasemap("sat");
  document.getElementById("bmOsm").onclick  = () => showBasemap("osm");
  document.getElementById("bmDark").onclick = () => showBasemap("dark");

  // --- KoBo puntos (cluster básico) ---
  let koboAll = null;

  function safe(v){
    if(v === null || v === undefined) return "";
    if(Array.isArray(v)) return v.join(", ");
    return String(v);
  }

  function buildPopupHTML(p){
    const f1 = p.foto_sitio_url ? `<div style="margin-top:6px"><a target="_blank" rel="noopener" href="${p.foto_sitio_url}">Foto sitio</a></div>` : "";
    const f2 = p.foto_actividad_url ? `<div style="margin-top:6px"><a target="_blank" rel="noopener" href="${p.foto_actividad_url}">Foto actividad</a></div>` : "";
    return `
      <div style="min-width:240px">
        <div style="font-weight:800;margin-bottom:6px">Boleta ${safe(p.id)}</div>
        <div style="font-size:12px"><b>Fecha:</b> ${safe(p.fecha_actividad)}</div>
        <div style="font-size:12px"><b>Municipios:</b> ${safe(p.municipios)}</div>
        <div style="font-size:12px"><b>Comunidad:</b> ${safe(p.comunidad)}</div>
        <div style="font-size:12px"><b>Sitio:</b> ${safe(p.sitio_nombre)}</div>
        <div style="font-size:12px"><b>Instituciones:</b> ${safe(p.instituciones)}</div>
        <div style="font-size:12px"><b>Plantas:</b> ${safe(p.total_plantas)}</div>
        <div style="font-size:12px"><b>Participantes:</b> ${safe(p.total_participantes)}</div>
        ${p.observaciones ? `<div style="font-size:12px;margin-top:6px"><b>Obs:</b> ${safe(p.observaciones)}</div>` : ""}
        ${f1}${f2}
      </div>
    `;
  }

  function fitToGeojson(geojson){
    const feats = geojson.features || [];
    if(!feats.length) return;
    const b = new maplibregl.LngLatBounds();
    for(const ft of feats){
      const g = ft.geometry;
      if(g && g.type === "Point") b.extend(g.coordinates);
    }
    if(!b.isEmpty()) map.fitBounds(b, {padding: 40, maxZoom: 14});
  }

  async function loadKobo(){
    statusBox.textContent = "Cargando puntos…";
    const r = await fetch("../../data/puntos.geojson", {cache:"no-store"});
    if(!r.ok) throw new Error("No pude cargar data/puntos.geojson");
    koboAll = await r.json();
    const n = (koboAll.features||[]).length;
    koboShown.textContent = n;
    koboTotal.textContent = n;

    if(!map.getSource("kobo")){
      map.addSource("kobo", {
        type: "geojson",
        data: koboAll,
        cluster: true,
        clusterRadius: 50,
        clusterMaxZoom: 14
      });

      map.addLayer({
        id: "kobo-clusters",
        type: "circle",
        source: "kobo",
        filter: ["has", "point_count"],
        paint: {
          "circle-color": "rgba(75,209,144,0.65)",
          "circle-radius": [
            "step", ["get", "point_count"],
            16,  20, 22,  50, 28,  200, 36
          ],
          "circle-stroke-color": "rgba(0,0,0,0.35)",
          "circle-stroke-width": 1
        }
      });

      map.addLayer({
        id: "kobo-cluster-count",
        type: "symbol",
        source: "kobo",
        filter: ["has", "point_count"],
        layout: { "text-field": "{point_count_abbreviated}", "text-size": 12 },
        paint: { "text-color": "#0b0f14" }
      });

      map.addLayer({
        id: "kobo-points",
        type: "circle",
        source: "kobo",
        filter: ["!", ["has", "point_count"]],
        paint: {
          "circle-color": "rgba(75,209,144,0.95)",
          "circle-radius": 6,
          "circle-stroke-color": "rgba(0,0,0,0.40)",
          "circle-stroke-width": 1
        }
      });

      map.on("click", "kobo-clusters", (e)=>{
        const features = map.queryRenderedFeatures(e.point, { layers: ["kobo-clusters"] });
        const clusterId = features[0].properties.cluster_id;
        map.getSource("kobo").getClusterExpansionZoom(clusterId, (err, zoom) => {
          if (err) return;
          map.easeTo({ center: features[0].geometry.coordinates, zoom: zoom });
        });
      });

      map.on("click", "kobo-points", (e)=>{
        const f = e.features && e.features[0];
        if(!f) return;
        new maplibregl.Popup({ maxWidth:"360px" })
          .setLngLat(e.lngLat)
          .setHTML(buildPopupHTML(f.properties || {}))
          .addTo(map);
      });

      fitToGeojson(koboAll);
    } else {
      map.getSource("kobo").setData(koboAll);
    }

    statusBox.textContent = "KoBo cargado ✓";
  }

  // =========================
  // IMPRESIÓN PRO (cajetín, norte, escala)
  // =========================
  function metersPerPixel(lat, zoom){
    return 156543.03392 * Math.cos(lat * Math.PI/180) / Math.pow(2, zoom);
  }

  function niceLengthMeters(raw){
    const candidates = [
      10,20,50,100,200,500,
      1000,2000,5000,10000,20000,50000
    ];
    let best = candidates[0];
    for(const c of candidates){
      if(c <= raw) best = c;
    }
    return best;
  }

  function formatMeters(m){
    if(m >= 1000) return (m/1000).toFixed((m%1000===0)?0:1) + " km";
    return m + " m";
  }

  function updatePrintLayout(){
    // Fecha / hora
    const now = new Date();
    const pad = n => String(n).padStart(2,"0");
    const fecha = `${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()}`;
    const hora  = `${pad(now.getHours())}:${pad(now.getMinutes())}`;

    document.getElementById("printDate").textContent = `${fecha} ${hora}`;
    document.getElementById("metaFecha").textContent = fecha;
    document.getElementById("metaHora").textContent = hora;

    // Norte (rotación si hay bearing)
    const bearing = map.getBearing() || 0;
    document.getElementById("northSvg").style.transform = `rotate(${-bearing}deg)`;
    document.getElementById("northSvg").style.transformOrigin = "50% 50%";

    // Escala
    const center = map.getCenter();
    const zoom = map.getZoom();
    const mpp = metersPerPixel(center.lat, zoom);

    // Medir px en el marco (para ajustar barra a un máximo físico)
    const frame = document.getElementById("mapFrame");
    const rect = frame.getBoundingClientRect();

    // mapFrame en impresión está definido como 277mm de ancho.
    // pxPerInch basado en ancho real (en px) / pulgadas del ancho.
    const inches = (277/25.4);
    const pxPerInch = rect.width / inches;

    // Denominador escala aproximada
    const scaleDen = Math.round(mpp * pxPerInch / 0.0254);
    document.getElementById("scaleRatio").textContent = `1:${scaleDen.toLocaleString("es-GT")}`;
    document.getElementById("metaEscala").textContent = `1:${scaleDen.toLocaleString("es-GT")}`;
    document.getElementById("metaZoom").textContent = zoom.toFixed(2);

    // Barra de escala: máximo 70mm dentro del recuadro
    const pxPerMm = rect.width / 277;
    const maxBarPx = pxPerMm * 70;

    const rawLen = mpp * maxBarPx;
    const niceLen = niceLengthMeters(rawLen);
    const barPx = Math.min(maxBarPx, niceLen / mpp);

    // Construir barra en 4 segmentos alternos
    const bar = document.getElementById("scaleBar");
    bar.innerHTML = "";
    const seg = 4;
    for(let i=0;i<seg;i++){
      const d = document.createElement("div");
      d.style.width = (barPx/seg) + "px";
      d.style.height = "100%";
      d.style.background = (i%2===0) ? "#000" : "#fff";
      bar.appendChild(d);
    }

    document.getElementById("scaleLabel").textContent = formatMeters(niceLen);
  }

  function printPDF(){
    // Entrar modo impresión, ajustar layout, imprimir y salir
    document.body.classList.add("print-mode");
    // asegurar que el mapa se ajuste al nuevo tamaño (print-mode)
    map.resize();

    // esperar un momentito para que re-renderice y luego calcular escala
    setTimeout(()=>{
      updatePrintLayout();
      window.print();
    }, 250);
  }

  window.addEventListener("afterprint", ()=>{
    document.body.classList.remove("print-mode");
    map.resize();
  });

  document.getElementById("printBtn").onclick = printPDF;

  map.on("load", async ()=>{
    showBasemap("sat");
    try{
      await loadKobo();
    }catch(e){
      console.error(e);
      statusBox.textContent = "Error cargando puntos.";
    }
  });
</script>
</body>
</html>
